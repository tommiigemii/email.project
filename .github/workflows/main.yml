name: Daily Email

on:
  # ⚠️ prima avevi "* * * * *" = ogni minuto (spam + caos)
  # Metti una volta al giorno. Esempio: 07:00 UTC (08:00 CET in inverno)
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: daily-email
  cancel-in-progress: true

jobs:
  send:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # Carica tutte le variabili dal secret EMAIL_DATA (righe KEY=VALUE)
      - name: Load EMAIL_DATA into env
        run: |
          if [ -z "${{ secrets.EMAIL_DATA }}" ]; then
            echo "Missing secret: EMAIL_DATA"
            exit 1
          fi
          printf "%s\n" "${{ secrets.EMAIL_DATA }}" >> "$GITHUB_ENV"

      # Debug sicuro: stampa solo se le chiavi esistono (non stampa valori)
      - name: Sanity check (safe)
        run: |
          python - <<'PY'
          import os

          must = ["EMAIL_USER", "EMAIL_PASS", "EMAIL_SUBJECT", "LINK_3D", "IMG_PREVIEW"]
          missing = [k for k in must if not os.getenv(k)]

          if not (os.getenv("EMAIL_RECIPIENT") or os.getenv("EMAIL_RECIPIENTS")):
              missing.append("EMAIL_RECIPIENTS (or EMAIL_RECIPIENT)")

          if not (os.getenv("EMAIL_BODY_FILE") or os.getenv("EMAIL_BODY")):
              missing.append("EMAIL_BODY_FILE (or EMAIL_BODY)")

          if missing:
              raise SystemExit(f"Missing env vars: {missing}")

          # controlla che IMG_PREVIEW sia un URL pubblico
          img = os.getenv("IMG_PREVIEW", "")
          if not (img.startswith("https://") or img.startswith("cid:")):
              raise SystemExit("IMG_PREVIEW must be an https:// URL (GitHub Pages) or cid:... (inline).")

          print("OK: env vars look good.")
          PY

      # Controllo file template (se usi EMAIL_BODY_FILE)
      - name: Check template file exists (if using EMAIL_BODY_FILE)
        run: |
          if [ -n "${EMAIL_BODY_FILE}" ]; then
            echo "EMAIL_BODY_FILE=${EMAIL_BODY_FILE}"
            if [ ! -f "${EMAIL_BODY_FILE}" ]; then
              echo "Template file not found: ${EMAIL_BODY_FILE}"
              echo "Repo files (maxdepth 3):"
              find . -maxdepth 3 -type f
              exit 1
            fi
            echo "Template OK"
          else
            echo "EMAIL_BODY_FILE not set (using EMAIL_BODY inline)"
          fi

      # Controllo path script (evita errori stupidi)
      - name: Check script exists
        run: |
          test -f email.addresser/email.addresser.py || (echo "Missing script: email.addresser/email.addresser.py" && find . -maxdepth 4 -type f && exit 1)
          echo "Script OK"

      - name: Send email
        run: python email.addresser/email.addresser.py
